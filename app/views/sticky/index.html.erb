<style>
    .wrapper {
        width: 92%;
        margin: 20px auto;
        min-width: 960px;
        max-width: 1260px; }

    header {
        width: 97%;
        float: left;
        display: block;
        margin-bottom: 20px;
        height: 45px;
        background: #eee; }

    header h1 {
        float: left;
        width: 32px;
        height: 32px;
        margin: 7px;
        text-indent: -9999px;
    }

    header .btn {
        float: right;
        padding: 12px;
        background: #ccc;
        margin: 3px;
        font-size: 13px;
        color: #333;
        text-decoration: none;
        text-shadow: 0 1px #fff; }

    header .new-list:hover {
        background: #c42c2c;
        color: #fff;
        text-shadow: none; }


    /* --- Todos ------------------------------------------------------------------------ */

    article {
        float: left;
        display: inline;
        width: 25%;
        margin: 15px 3%;
        min-height: 260px; }

    .todo-inner {
        float: left;
        display: block;
        padding: 10px;
        width: 100%;
        position: relative;
        background-image: -webkit-gradient(linear,left bottom,left top,color-stop(1, rgb(255,255,255)),color-stop(0, rgb(220,220,220)));
        background-image: -moz-linear-gradient(center bottom,rgb(255,255,255) 100%,rgb(220,220,220) 0%);
        border-radius: 5px;
        border: 1px dashed #000;
        -webkit-box-shadow: 0 0 5px #000; }

    .todo-inner h3 {
        float: left;
        padding: 3px;
        max-width: 85%;
        font-family: helvetica;
        font-size: 20px;
        margin: 5px 0 ;
        text-shadow: 0 1px #fff; }

    .todo-inner nav {
        position: absolute;
        right: 0px;
        top: 0px;
        background: #c42c2c;
        width: 60px;
        height: 30px;
        border-bottom-left-radius: 10px;
        display: none; }

    .todo-inner nav span.delete, .todo-inner nav span.move {
        position: absolute;
        text-indent: -9999px;
        width: 16px;
        height: 16px; }

    .todo-inner nav span.delete {
        background: url('../images/delete.png') no-repeat;
        right: 8px;
        top: 6px;
        cursor: pointer; }

    .todo-inner nav span.move {
        background: url('../images/move.png') no-repeat;
        right: 30px;
        top: 6px;
        cursor: move; }

    /*  Todo list */
    article ul { display: block; }

    article ul li {
        position: relative;
        list-style: none;
        float: left;
        width: 98%;
        padding: 6px 1%;
        font-size: 15px; }

    article ul li input {
        float: left;
        margin-right: 6px;
        vertical-align: top; }

    article ul li span.content {
        float: left;
        max-width: 70%;
        padding: 1px 8px 1px 4px;
        text-shadow: 0 1px #fff;
        -webkit-transition: .4s,.4s; }

    article ul li span.content:focus, article ul li span.content:hover, article h3:hover, article h3:focus { background: #EBF599; }

    article ul li span.delete, article ul li span.move {
        position: absolute;
        text-indent: -9999px;
        width: 16px;
        height: 16px;
        display: none; }

    article ul li span.delete {
        background: url('../images/delete.png') no-repeat;
        right: 0;
        top: 6px;
        cursor: pointer; }

    article ul li span.move {
        background: url('../images/move.png') no-repeat;
        right: 24px;
        top: 5px;
        cursor: move; }

    article ul li span.checked { text-decoration: line-through; }

    input.add-todo {
        float: left;
        display: block;
        margin-top: 8px;
        margin-left: 5px;
        width: 90%;
        padding: 4px; }


    /* --- Other ------------------------------------------------------------------------ */

    #help {
        margin: 10% auto;
        padding: 15px 25px;
        width: 500px;
        height: auto;
        overflow: auto;
        background-image: -webkit-gradient(
                linear,
                left bottom,
                left top,
                color-stop(1, rgb(255,255,255)),
                color-stop(0, rgb(245,245,245))
        );
        background-image: -moz-linear-gradient(
                center bottom,
                rgb(255,255,255) 100%,
                rgb(245,245,245) 0%
        );
        border: 1px dashed rgb(17,27,46);
        -webkit-box-shadow: 0 0 6px #000;
        -moz-box-shadow: 0 0 6px #000;
        border-radius: 5px;
        -moz-border-radius: 5px; }

    #help h3 {
        font-size: 16px;
        font-weight: bold;
        font-family: helvetica;
        text-transform: uppercase;
        color: #222;
        text-shadow: 0 1px #fff;
        margin: 40px 0 5px 0; }

    #help p {
        font-size: 13px;
        color: #333;
        margin-bottom: 20px;
        text-align: justify;
        text-shadow: 0 1px #fff; }

    #help p a { color: red; }

    .button {
        font-family: helvetica;
        font-size: 12px;
        color: #333;
        text-decoration: none;
        background-image: -webkit-gradient(
                linear,
                left bottom,
                left top,
                color-stop(1, #eee),
                color-stop(0, #ccc)
        );
        background-image: -moz-linear-gradient(center bottom, #eee 100%, #ccc 0%);
        padding: 8px 15px;
        border-radius: 6px;
        border: 1px solid #ddd;
        -webkit-box-shadow: 0 0 2px #000;
        float: right;
        margin-top: 15px;
        text-shadow: 0 1px #fff; }

    .button:hover {
        background-image: -webkit-gradient(
                linear,
                left bottom,
                left top,
                color-stop(1, #eee),
                color-stop(0, #bbb)
        ); }

    .info {
        position: fixed;
        bottom: 0;
        right: 0;
        width: 40px;
        height: 40px;
        text-align: center;
        line-height: 40px;
        background: #c42c2c;
        font-size: 12px;
        text-decoration: none;
        color: #fff; }

    .mhealth {
        position: fixed;
        bottom: 0;
        left: 0;
        text-align: center;
    }

    .github {
        position: absolute;
        bottom: 14px;
        right: 55px;
        color: #ccc;
        font-size: 13px;
    }

    #html5_bg {
        z-index: -1;
        position: absolute;
        top: 40%;
        width: 100%;
        text-align: center;
        #text-transform: uppercase; }

    #html5_bg p {
        font-size: 120px;
        font-weight: bold;
        color: rgb(17,27,55);
        text-shadow: 0 -1px #000, 0 1px rgb(17,27,75); }
</style>
<div class="wrapper">
  <header>
    <h1>Todo</h1>
    <a href="#" id="btn_save" class="btn">Save</a>
    <a href="#" class="new-list btn">Add new list +</a>
  </header>
  <div id="todo-lists"></div>
</div>
<div id="html5_bg"><p>mTask Board</p></div>

<script>
    $(document).ready(function(){
        localStorage.clear('todos');
        var todos_saved = ''
        <% if @taskboards %>
        localStorage.setItem("todos", <%= @taskboards.todos.inspect.html_safe %>);
        todos_saved= <%= @taskboards.todos.inspect.html_safe %>;
        <% end %>

        if (localStorage.getItem("todos")) {
            var todos = new Array();
            todos.lists = JSON.parse(localStorage.getItem("todos"));
        } else {
            var todos = new Array();
            todos.lists = [{
                title: 'Click me to edit',
                todos: [{
                    text: 'Add your first todo',
                    status: 'checked'
                }, {
                    text: 'Get things done.',
                    status: false
                }]
            }]
        }

        /* Print todos on screen */

        $.each(todos.lists, function (key, value) {
            $('#todo-lists').append('<article id="list-' + key + '"><div class="todo-inner"><h3 contenteditable="true">' + value.title + '</h3><nav><span class="delete">x</span><span class="move">+</span></nav><ul></ul><input type="text" class="add-todo" placeholder="Type and hit enter..." /></div></article>');

            $.each(todos.lists[key].todos, function (i, val) {
                if (val.status) {
                    var checked = 'checked';
                } else {
                    var checked = '';
                }
                $('#list-' + key + ' ul').append('<li><input type="checkbox" class="todo-' + i + '" ' + checked + ' /> <span contenteditable="true" class="content ' + checked + '">' + val.text + '</span><span class="move">+</span><span class="delete">x</span></li>');
            })
        });
        refresh();

        /* ==================================================================== */
        /*  TodoApp - A simple todo app built with HTML5 and javascript.        */
        /*  Version 0.1                                                         */
        /*  By Filip Stefansson                                                 */
        /* ==================================================================== */



        /* -- User experience ------------------------------------------------- */
        function off_listener(){
            $('article .todo-inner').off();
// On enter
            $('h3, span[contenteditable=true]').off();

            $('span[contenteditable=true]').off();
            $('.add-todo').off();
            $('input[type=checkbox]').off();
            $('nav .delete').off();

        }
        function set_listener(){
            off_listener();
            $('li').on('mouseenter mouseleave', function (event) {
                if (event.type == 'mouseenter') {
                    $(this).find('span.move').stop(true, true).fadeIn(500);
                    $(this).find('span.delete').stop(true, true).delay(50).fadeIn(500);
                } else {
                    $(this).find('span.move').stop(true, true).fadeOut(500);
                    $(this).find('span.delete').stop(true, true).delay(50).fadeOut(500);
                }
            });

            $('article .todo-inner').on('mouseenter mouseleave', function (event) {
                if (event.type == 'mouseenter') {
                    $(this).find('nav').stop(true, true).fadeIn(300);
                } else {
                    $(this).find('nav').stop(true, true).fadeOut(300);
                }
            });

// On enter
            $('h3, span[contenteditable=true]').on('keydown', function (e) {
                if (e.keyCode == 13) {
                    e.preventDefault();
                }
            });

            $('h3, span[contenteditable=true]').on('keyup', function (e) {
                if (e.keyCode == 13) {
                    $('h3, span[contenteditable=true]').blur();
                    $(this).parent('nav').parent('div').parent('article').find('input[type=text]').focus();
                }
            });

            $('span[contenteditable=true]').on('keyup', function (e) {
                if (e.keyCode == 13) {
                    $('span[contenteditable=true]').blur();
                    $(this).parent('li').next('li').find('span[contenteditable=true]').focus();
                }
            });


            $('.add-todo').on('keyup', function (e) {
                if (e.keyCode == 13) {
                    var listID = $(this).parent('div').parent('article').attr('id').replace('list-', '');
                    var position = todos.lists[listID].todos.length;
                    var value = $(this).val();

                    todos.lists[listID].todos.push(position);

                    todos.lists[listID].todos[position] = {
                        text: value,
                        status: false
                    }
                    localStorage.setItem("todos", JSON.stringify(todos.lists));

                    $(this).parent('div').find('ul').append('<li><input type="checkbox" class="todo-' + position + '"/><span contenteditable="true">' + value + '</span><span class="move">+</span><span class="delete">x</span></li>');
                    $(this).val('');
                    refresh();
                }
            });

            $('#todo-lists').on("sortstop", function (event, ui) {
                if (event.target.nodeName == 'DIV') {
                    var newPosition = ui.item.index();
                    var oldPosition = ui.item.attr('id').replace('list-', '');


                    var theList = todos.lists.slice(oldPosition);
                    todos.lists.splice(oldPosition, 1);
                    todos.lists.splice(newPosition, 0, theList[0])
                    localStorage.setItem("todos", JSON.stringify(todos.lists));

                    var i = 0;
                    $('#todo-lists article').each(function () {
                        $(this).attr('id', 'list-' + i);
                        i++;
                    });
                }
            });



            /* -- New positon(todo) ------------------------------------------------ */


            $('ul').on("sortstop", function (event, ui) {
                if (event.target.nodeName == 'UL') {
                    var oldPos = ui.item.find('input').attr('class').replace('todo-', '');
                    var newPos = ui.item.index();
                    var theList = ui.item.parent('ul').parent('div').parent('article').attr('id').replace('list-', '');

                    var theTodo = todos.lists[theList].todos.slice(oldPos);
                    todos.lists[theList].todos.splice(oldPos, 1);
                    todos.lists[theList].todos.splice(newPos, 0, theTodo[0])
                    localStorage.setItem("todos", JSON.stringify(todos.lists));

                    var i = 0;
                    $('#list-' + theList + ' ul li input').each(function () {
                        $(this).attr('class', 'todo-' + i);
                        i++;
                    });
                }
            });

            $('ul').on("sortreceive", function (event, ui) {
                if (event.target.nodeName == 'UL') {
                    var oldPos = ui.item.find('input').attr('class').replace('todo-', '');
                    var oldList = ui.sender.parent('div').parent('article').attr('id').replace('list-', '');

                    var newList = ui.item.parent('ul').parent('div').parent('article').attr('id').replace('list-', '');
                    var newPos = ui.item.index();

                    var theTodo = todos.lists[oldList].todos.slice(oldPos);
                    todos.lists[oldList].todos.splice(oldPos, 1);
                    todos.lists[newList].todos.splice(newPos, 0, theTodo[0])
                    localStorage.setItem("todos", JSON.stringify(todos.lists));

                    var i = 0;
                    $('#list-' + newList + ' div ul li input').each(function () {
                        $(this).attr('class', 'todo-' + i);
                        i++;
                    });
                    var index = 0;
                    $('#list-' + oldList + ' div ul li input').each(function () {
                        $(this).attr('class', 'todo-' + index);
                        index++;
                    });
                }
            })



            /* -- On check --------------------------------------------------------- */

            $('input[type=checkbox]').on('click', function () {
                var listID = $(this).parent('li').parent('ul').parent('div').parent('article').attr('id').replace('list-', '');
                var todoID = $(this).attr('class').replace('todo-', '');
                if (todos.lists[listID].todos[todoID].status == false) {
                    todos.lists[listID].todos[todoID].status = 'checked';
                    $('#list-' + listID + ' li input.todo-' + todoID).parent('li').find('span').addClass('checked');
                } else {
                    todos.lists[listID].todos[todoID].status = false;
                    $('#list-' + listID + ' li input.todo-' + todoID).parent('li').find('span').removeClass('checked');

                }

                localStorage.setItem("todos", JSON.stringify(todos.lists));

            })

            /* -- On update(todo) -------------------------------------------------- */

            $("span[contenteditable=true]").on('blur', function () {
                var listID = $(this).parent('li').parent('ul').parent('div').parent('article').attr('id').replace('list-', '');
                var todoID = $(this).parent('li').find('input').attr('class').replace('todo-', '');

                todos.lists[listID].todos[todoID].text = $(this).html();

                localStorage.setItem("todos", JSON.stringify(todos.lists));
            })




            /* -- On update(title) ------------------------------------------------- */

            $("article div h3").on('blur', function () {
                var listID = $(this).parent('div').parent('article').attr('id').replace('list-', '');

                todos.lists[listID].title = $(this).html();

                localStorage.setItem("todos", JSON.stringify(todos.lists));
            })



            /* -- On delete(list) -------------------------------------------------- */

            $('nav .delete').on('click', function () {
                var listID = $(this).parent('nav').parent('div').parent('article').attr('id').replace('list-', '');

                todos.lists.splice(listID, 1);

                if (todos.lists.length == 0) {
                    localStorage.clear('todos');
                } else {
                    localStorage.setItem("todos", JSON.stringify(todos.lists));
                }

                $(this).parent('nav').parent('div').parent('article').fadeOut(200, function (index) {
                    $(this).remove();

                    $('article').each(function () {
                        var currentID = $(this).attr('id').replace('list-', '');
                        if (currentID > listID) {
                            var newID = currentID - 1;

                            $(this).attr('id', 'list-' + newID);
                        }
                    });
                });

            })



            /* -- On delete(todo) -------------------------------------------------- */


            $('li .delete').on('click', function () {
                var todoID = $(this).parent('li').find('input').attr('class').replace('todo-', '');
                var listID = $(this).parent('li').parent('ul').parent('div').parent('article').attr('id').replace('list-', '');

                todos.lists[listID].todos.splice(todoID, 1);

                localStorage.setItem("todos", JSON.stringify(todos.lists));

                $(this).parent('li').fadeOut(200, function (index) {
                    $(this).remove();

                    $('#list-' + listID + ' div ul li').each(function () {
                        var currentID = $(this).find('input').attr('class').replace('todo-', '');
                        if (currentID > todoID) {
                            var newID = currentID - 1;

                            $(this).find('input').attr('class', 'todo-' + newID);
                        }
                    });
                });
            })


        }


        /* -- Useful functions ------------------------------------------------- */

        function reset() {
            localStorage.clear('todos');
            alert('Local Storage Reset: Done!')
        }


        function refresh() {
            set_listener();
            $("ul").sortable({
                connectWith: 'ul',
                handle: 'span.move'
            });

            /* Move the whole lists around. */
            $("#todo-lists").sortable({
                handle: 'nav span.move'
            });
        }

        function save(){
            if(localStorage.getItem("todos") != todos_saved){
                $.getScript('/sticky/save.js?todos='+JSON.stringify(todos.lists))
                todos_saved =  localStorage.getItem("todos")
            }
        }

        $('#btn_save').on('click', function(){
            if(localStorage.getItem("todos") != todos_saved){
                $.getScript('/sticky/save.js?todos='+JSON.stringify(todos.lists), function( data, textStatus, jqxhr ) {
                    console.log( data ); // Data returned
                    console.log( textStatus ); // Success
                    console.log( jqxhr.status ); // 200
                    console.log( "Load was performed." );
                    alert('Saved')
                });

                todos_saved =  localStorage.getItem("todos")
            }
        })

        setInterval(function(){save()}, 15000);



        /* -- Init ------------------------------------------------------------- */



        /* -- New list --------------------------------------------------------- */

        $('.new-list').on('click', function (event) {
            event.preventDefault();
            var position = todos.lists.length;
            todos.lists.push(position);

            var listNames = ['Enter a Task', 'Make a List', 'Enter a Todo Item', 'Jot a Note'];
            var listItems = ['Task Item 1', 'List Item 1', 'Todo Item 1', 'Note Item 1']
            var rand = Math.floor(Math.random() * 4)

            todos.lists[position] = {
                title: listNames[rand],
                todos: [{
                    text: listItems[rand],
                    status: false
                }]
            }

            $('#todo-lists').append('<article id="list-' + position + '"><div class="todo-inner"><h3 contenteditable="true">' + listNames[rand] + '</h3><nav><span class="delete">x</span><span class="move">+</span></nav><ul class="ui-sortable"><li><input type="checkbox" class="todo-0" /><span contenteditable="true" class="content">' + listItems[rand] + '</span><span class="move">+</span><span class="delete">x</span></li></ul><input type="text" class="add-todo" placeholder="Type and hit enter..." /></div></article>');

            refresh();

            localStorage.setItem("todos", JSON.stringify(todos.lists));

            $('#list-' + position).find('h3').focus();

        });



        /* -- New todo --------------------------------------------------------- */




        /* -- New positon(list) ------------------------------------------------ */
    })
</script>