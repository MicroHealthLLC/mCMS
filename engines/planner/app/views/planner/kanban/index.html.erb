<%= stylesheet_link_tag "planner/application", media: "all" %>
<div class="row" ng-app="mpk" ng-controller="myController">
  <div class="col-xs-12">
    <!--[if lt IE 7]>
    <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <div ng-view>
    </div>

    <script type="text/ng-template" id="kanban.html">

      <header class="navbar navbar-fixed-top" role="navigation" id="headerMenu">
        <div class="navbar-inner">
          <div class="container">
            <div class="navbar-header col-sm-6">
              <span id="kanbanName" class="navbar-brand" ng-model="kanban" ng-hide="editingName"><a class="renameKanban" ng-click="editingKanbanName()">{{kanban.name}}</a></span>
              <div ng-show="editingName" class="pull-left">
                <form ng-submit="rename()" >
                  <div class="input-group">
              <span class="input-group-addon">
                <a ng-click="editingName=false"><i class="glyphicon glyphicon-tasks"></i></a>
              </span>
                    <input type="text" name="kanbanName" ng-model="newName" class="form-control" />
                  </div>
                </form>
              </div>
            </div>
            <div class="col-sm-6">
              <ul class="nav navbar-nav pull-right" id="menu">
                <li class="dropdown">
                  <a class="dropdown-toggle" data-toggle="dropdown">Task <span class="caret"></span></a>
                  <ul class="dropdown-menu">
                    <li><a class="mpkNew" title="New Task board" ng-click="kanbanMenu.openNewKanban()"><i class="glyphicon glyphicon-briefcase"></i> New</a></li>
                    <li><a title="Downloadelete Task from local storage" ng-click="kanbanMenu.delete()"><i class="glyphicon glyphicon-remove-sign"></i> Delete</a></li>
                    <li><a title="Select Theme for the Task board" ng-click="kanbanMenu.openSwitchTheme()"><i class="glyphicon glyphicon-picture"></i> Themes</a></li>
                    <li><a title="Open archive" ng-click="kanbanMenu.openArchive(kanban)"><i class="glyphicon glyphicon-folder-open"></i> Archives</a></li>
                    <li><a title="Setup the Task board" ng-click="kanbanMenu.openSetup()"><i class="glyphicon glyphicon-edit"></i> Setup</a></li>
                    <li role="presentation" class="divider"></li>
                    <li><a title="Export Task to file" ng-click="kanbanMenu.openExport(allKanbans, kanban.name)" href=""><i class="glyphicon glyphicon-save"></i> Export</a></li>
                    <li><a title="Import Task from file" ng-click="kanbanMenu.openImport()" href=""><i class="glyphicon glyphicon-open"></i> Import</a></li>
                  </ul>
                </li>
              </ul>
              <div id="info" class="nav pull-right" ng-show="showInfo">
                <span id="error" class="error" ng-show="showError"><a ng-click="showInfo=false;showError=false;errorMessage=''">{{errorMessage}}</a></span>
                <span id="message" class="">{{infoMessage}}</span>
                <span id="spinner" class="pull-right" spin="spinConfig" spin-if="showSpinner"></span>
              </div>
              <div id="quickSwitch" class="pull-right form-group">
                <form>
                  <select ng-model="switchTo" ng-options="name for name in switchToList" ng-change="switchToKanban(switchTo)">
                    <option>Switch to ...</option>
                  </select>
                </form>
              </div>
            </div>
          </div>
        </div>
      </header>


      <div class="container-fluid" id="kanban" ng-controller="KanbanController">
        <div id="columns" class="row" ng-class="sortableClassFor(kanban)" ui-sortable="{connectWith: '#kanban div.columns'}" ng-model="kanban.columns">
          <div class="col-xs-12 col-sm-6 col-md-4 col-lg-3" ng-repeat="column in kanban.columns" data-columnindex="{{$index}}" id="column{{$index}}">
            <div class="column" style="background-color: {{column.settings.color}}">
              <div class="columnHeader">
                <a title="Delete Column" class="pull-left deletebtn" ng-click="deletecol(kanban, column)"><i class="glyphicon glyphicon-remove"></i></a>
                <a title="Add Column" class="pull-right addbtn" ng-click="addcol(kanban, column, 'right')"><i class="glyphicon glyphicon-plus"></i></a>
                <span class="columnname"><a title="Column settings" ng-click="columnSettings(kanban, column)" ng-model="column" ng-hide="editing">{{column.name}}</a> ({{columnLimitsTextFor(column)}})</span>
              </div>
              <ul ng-class="sortableClassFor(column)" ui-sortable="{connectWith: '#kanban ul.cards'}" ng-model="column.cards" style="min-height:{{columnHeight}}px;max-height:{{columnHeight}}px;">
                <li class="card" ng-repeat="card in column.cards" style="background-color: #{{colorFor(card)}};">
                  <a class="pull-left deletebtn" ng-click="delete(card, column)"><i class="glyphicon glyphicon-remove"></i></a>
                  <a class="pull-right" title="Archive" ng-click="archive(kanban, column, card)" ng-show="isLastColumn(column.name, kanban)"><i class="glyphicon glyphicon-folder-close"></i></a>
                  <a class="cardname" ng-click="openCardDetails(card)"><span>{{card.name}}</span></a><br><br><p>Category: {{card.taskcategory}}<br>Type: {{card.tasktype.name}}</p><p class="cardinfo">Start date: {{card.startdate}}<br>Due date: {{card.duedate}}<br>Complete date: {{card.completedate}}</p>
                </li>
                <button type="button" title="Add card to column" class="btn btn-sm btn-default addcardbtn" ng-click="addNewCard(column)" ng-hide="columnLimitsReached(column)"><i class="glyphicon glyphicon-plus"></i>&nbsp;&nbsp;&nbsp;&nbsp;</button>
                </li>
              </ul>
            </div>
          </div><!-- row -->
        </div>


        <div ng-controller="ColumnSettingsController">
          <mpk-modal title="Column settings" visible="showColumnSettings">
            <form class="noMargin" name="columnSettings" ng-submit="update()">
              <div class="form-group" ng-controller="columnNameCtrl">
                <label class="control-label" for="columnName">Column name (Status)</label> &nbsp;&nbsp; <span class="notetext">NOTE: Leave &quot;Please select&quot; to keep &quot;Column #&quot; as column header.</span><br>
                <select id="columnName" name="columnName" ng-model="model.columnName" class="form-control" ng-options="colstatus for colstatus in columnstatus">
                  <option value="">---Please select---</option>
                </select>
              </div>
              <div class="row">
                <div class="col-xs-6">
                  <label class="control-label" for="columnColor">Column color</label>
                </div>
                <div class="controls col-xs-3">
                  <input type="text" name="colorHex" placeholder="#999999" value="Theme Default" class="form-control" ng-model="model.color" />
                </div>
                <div class="controls col-xs-3">
                  <spectrum-colorpicker ng-model="model.color" options="{allowEmpty: true}" format="'hex'">
                  </spectrum-colorpicker>
                </div>
              </div><!-- row -->
              <br>
              <div class="row">
                <div class="col-xs-6">
                  <label class="control-label" for="columnLimit">Card limit for this column</label>
                </div>
                <div class="controls col-xs-6">
                  <input name="columnLimit" id="columnLimit" type="number" ng-model="model.limit" class="form-control" onChange="limitChange()" min="1" />
                  <p id="nolimit">NOTE: Leave blank for no limit.</p>
                </div>
                <div hidden class="controls col-xs-12">
                  <input name="cardsTotal" id="cardsTotal" type="number" ng-model="model.limit2" />
                </div>
              </div><!-- row -->
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary">Update</button>
              </div>
            </form>
          </mpk-modal>
        </div>


        <div ng-controller="NewKanbanCardController">
          <mpk-modal title="New card for column" visible="showNewCard">
            <form class="noMargin" name="newCardForm" ng-submit="addNewCard(newCard)">
              <div class="form-group">
                <label class="control-label" for="newCardTitle">Task card title</label>
                <input type="text" id="newCardTitle" placeholder="Title on a card" ng-model="newCard.title" required focus-me class="cardInputs form-control" name="cardTitle"/>
              </div>
              <div class="form-group">
                <label class="control-label" for="newCardDetails">More details <small>(optional)</small></label>
            <textarea id="newCardDetails" ng-model="newCard.details" class="cardInputs form-control" rows="7">
            </textarea>
              </div>
              <div class="form-group">
                <label class="control-label">Card color</label><br>
                <color-selector options="colorOptions" ng-model="newCard.cardColor" prefix="newCardColor" class="colorSelector" show-hex-code="true"/>
              </div>
              <div class="row">
                <div class="col-xs-6">
                  <div class="form-group" ng-controller="newTaskCategoryCtrl">
                    <label class="control-label" for="newCardTaskCategory">Category</label><br>
                    <select id="newCardTaskCategory" name="newCardTaskCategory" ng-model="newCard.taskcategory" class="cardInputs form-control" ng-options="category for category in categories">
                      <option value="">---Please select---</option>
                    </select>
                  </div>
                </div>
                <div class="col-xs-6">
                  <div class="form-group" ng-controller="newTaskTypeCtrl">
                    <label class="control-label" for="newCardTaskType">Type</label><br>
                    <select id="newCardTaskType" name="newCardTaskType" ng-model="newCard.tasktype" class="cardInputs form-control" ng-options="type.name for type in types">
                      <option value="">---Please select---</option>
                    </select>
                  </div>
                </div>
              </div><!-- row -->
              <div class="row">
                <div class="col-xs-6">
                  <div class="form-group">
                    <label class="control-label" for="newCardStartDate">Start Date</label>
                    <input type="text" id="newCardStartDate" name="cardStartDate" ng-model="newCard.startdate" date-options="dateOptions" custom-datepicker />
                  </div>
                </div>
                <div class="col-xs-6">
                  <div class="form-group">
                    <label class="control-label" for="newCardDueDate">Due Date</label>
                    <input type="text" id="newCardDueDate" name="cardDueDate" ng-model="newCard.duedate" date-options="dateOptions" custom-datepicker />
                  </div>
                </div>
                <div class="col-xs-6">
                  <div class="form-group">
                    <label class="control-label" for="newCardCompleteDate">Complete Date</label>
                    <input type="text" id="newCardCompleteDate" name="cardCompleteDate" ng-model="newCard.completedate" date-options="dateOptions" custom-datepicker />
                  </div>
                </div>
              </div><!-- row -->
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary">Add</button>
              </div>
            </form>
          </mpk-modal>
        </div>


        <div ng-controller="CardController">
          <mpk-modal title="Card details" visible="showCardDetails">
            <form class="noMargin" name="cardDetails">
              <div class="form-group">
                <label class="control-label" for="cardTitle">Task card title</label>
                <div class="controls">
                  <ng-form ng-submit="editingTitle = true">
                    <input name="cardTitle" type="text" id="cardTitle" placeholder="Title on a card" ng-model="card.name" ng-change="nameChanged()" required class="form-control" ng-enabled="editingTitle" focus-me />
                  </ng-form>
                </div>
              </div>
              <div class="form-group">
                <label class="control-label" for="cardDetails">Details</label>
                <div class="controls">
                  <ng-form ng-submit="editingDetails = true">
                    <textarea id="details" ng-model="card.details" class="cardInputs form-control" ng-enabled="editingDetails" rows="7"></textarea>
                  </ng-form>
                </div>
              </div>
              <div class="form-group">
                <label class="control-label">Card color</label><br>
                <color-selector options="colorOptions" ng-model="card.color" prefix="editCardColor" class="colorSelector" show-hex-code="true" />
              </div>
              <div class="row">
                <div class="col-xs-6">
                  <div class="form-group" ng-controller="taskCategoryCtrl">
                    <label class="control-label" for="cardTaskCategory">Category</label><br>
                    <ng-form ng-submit="editingTaskCategory = true">
                      <select id="cardTaskCategory" name="cardTaskCategory" ng-model="card.taskcategory" class="cardInputs form-control" ng-change="categoryChanged(card.taskcategory)" ng-options="category for category in categories" ng-enabled="editingTaskCategory">
                        <option value="">---Please select---</option>
                      </select>
                    </ng-form>
                  </div>
                </div>
                <div class="col-xs-6">
                  <div class="form-group" ng-controller="taskTypeCtrl">
                    <label class="control-label" for="cardTaskType">Type</label><br>
                    <ng-form ng-submit="editingTaskType = true">
                      <select id="cardTaskType" name="cardTaskType" ng-model="card.tasktype" class="cardInputs form-control" ng-options="type.name for type in types" ng-enabled="editingTaskType">
                        <option value="">---Please select---</option>
                      </select>
                    </ng-form>
                  </div>
                </div>
              </div><!-- row -->
              <div class="row">
                <div class="col-xs-6">
                  <div class="form-group">
                    <label class="control-label" for="cardStartDate">Start Date</label>
                    <ng-form ng-submit="editingStartDate = true">
                      <input type="text" id="cardStartDate" name="cardStartDate" ng-model="card.startdate" date-options="dateOptions" custom-datepicker ng-enabled="editingStartDate" />
                    </ng-form>
                  </div>
                </div>
                <div class="col-xs-6">
                  <div class="form-group">
                    <label class="control-label" for="cardDueDate">Due Date</label>
                    <ng-form ng-submit="editingDueDate = true">
                      <input type="text" id="cardDueDate" name="cardDueDate" ng-model="card.duedate" date-options="dateOptions" custom-datepicker ng-enabled="editingDueDate" />
                    </ng-form>
                  </div>
                </div>
                <div class="col-xs-6">
                  <div class="form-group">
                    <label class="control-label" for="cardCompleteDate">Complete Date</label>
                    <ng-form ng-submit="editingCompleteDate = true">
                      <input type="text" id="cardCompleteDate" name="cardCompleteDate" ng-model="card.completedate" date-options="dateOptions" custom-datepicker ng-enabled="editingCompleteDate" />
                    </ng-form>
                  </div>
                </div>
              </div><!-- row -->
            </form>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
          </mpk-modal>
        </div>
      </div>


      <div ng-controller="NewKanbanController">
        <mpk-modal title="New Task board" visible="showNewKanban">
          <form class="noMargin" name="newKanbanForm">
            <div class="form-group">
              <label class="control-label" for="kanbanNameFormField">Task name</label>
              <input type="text" id="kanbanNameFormField" placeholder="Task name" class="form-control" ng-model="model.kanbanName" required focus-me />
            </div>
            <div class="form-group">
              <label class="control-label" for="numberOfColumnsField">Number of columns</label>
              <select id="numberOfColumnsField" ng-model="model.numberOfColumns" class="form-control" ng-options="number for number in [2,3,4,5,6,7,8,9]">
              </select>
            </div>
            <hr />
            <div class="form-group">
              <label for="fromTemplate">Use existing Task as template</label>
              <select id="fromTemplate" name="fromTemplate" ng-model="model.useTemplate" ng-options="name for name in model.kanbanNames" class="form-control">
                <option>Existing tasks ...</option>
              </select>
            </div>
            <div class="alert alert-info">
              <p>When using existing Task as template, <strong>number of columns</strong> and respective <strong>names</strong> will be used.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary" ng-click="createNew()">Create new</button>
            </div>
          </form>
        </mpk-modal>
      </div>


      <div ng-controller="SwitchThemeController">
        <mpk-modal title="Choose Task Theme" visible="showSwitchTheme">
          <form ng-submit="switchTheme()" name="selectTheme" class="noMargin">
            <div class="form-group">
              <label class="control-label" for="kanbanTheme">Themes to choose from</label>
            </div>
            <div class="row">
              <div class="col-sm-5">
                <select class="form-control" name="selectedToOpen" ng-model="model.selectedTheme" required ng-options="t.css as t.name for t in model.themes" id="kanbanTheme">
                </select>
                <br>
              </div>
              <div class="col-sm-5">
                <img src="img/themes/{{model.selectedTheme}}.jpg" width="250" class="thumbnail" style="border: 1px solid black"/>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-default" type="button" data-dismiss="modal">Close</button>
              <button class="btn btn-primary" type="submit">Switch</button>
            </div>
          </form>
        </mpk-modal>
      </div>


      <div ng-controller="ArchiveController">
        <mpk-modal title="Cards Archive" visible="showArchive" id="archiveinfo" modal-style="width: 100%;">
          <form class="form-horizontal" role="form">
            <div class="form-group has-success">
              <div class="col-xs-offset-3 col-xs-9 col-sm-offset-6 col-sm-6">
                <input type="text" name="filterByName" placeholder="Filter by card name ..." ng-model="model.filterByName" class="form-control" />
              </div>
            </div>
          </form>
          <table class="table table-bordered">
            <thead>
            <tr>
              <th></th>
              <th style="width: 25%">Archived on</th>
              <th style="width: 33%">Card title</th>
              <th style="width: 40%">Description</th>
            </tr>
            </thead>
            <tr ng-repeat="archivedCard in model.archived | archiveByCardName:model.filterByName">
              <td><input type="radio" name="selectedCards[]" value="archivedCard.card.name" ng-model="archivedCard.selected" /></td>
              <td>{{formatDate(archivedCard.archivedOn)}}</td>
              <td>{{archivedCard.card.name}}</td>
              <td>{{archivedCard.card.details}}</td>
            </tr>
            <tbody>
            </tbody>
          </table>
          <div class="modal-footer">
            <button class="btn btn-warning pull-left" ng-click="unarchiveSelected()">Un-archive selected</button>
            <button class="btn btn-danger pull-left" ng-click="deleteSelected()">Delete selected</button>
            <button class="btn btn-default" type="button" data-dismiss="modal">Close</button>
          </div>
      </div>


      <div ng-controller="SetupController">
        <mpk-modal title="Setup Task board" visible="showSetup">
          <form ng-submit="setupTaskStatuses()" name="taskStatusesEnumerations" class="noMargin">
            <div class="form-group">
              <label class="control-label" for="taskStatuses">Column Names (Statuses)<br>
                <span class="notetext">Input each item separated by a comma.</span></label>
              <input type="text" id="taskStatuses" class="form-control" ng-model="model.taskstatuses" placeholder="Item 1, Item 2, Item 3" />
              <button class="btn btn-primary" type="submit" id="btntaskstatuses">Save</button>
            </div>
          </form>
          <br><br>
          <form ng-submit="setupTaskCategories()" name="taskCategoriesEnumerations" class="noMargin">
            <div class="form-group">
              <label class="control-label" for="taskCategories">Task Categories<br>
                <span class="notetext">Input each item separated by a comma.</span></label>
              <input type="text" id="taskCategories" class="form-control" ng-model="model.taskcategories" placeholder="Item 1, Item 2, Item 3" />
              <button class="btn btn-primary" type="submit" id="btntaskcategories">Save</button>
            </div>
          </form>
          <br><br>
          <form ng-submit="setupTaskTypes()" name="taskTypesEnumerations" class="noMargin">
            <div class="form-group">
              <label class="control-label" for="taskTypes">Task Types<br>
                <span class="notetext">Input each pairing alternating between item type name and its corresponding category name, separated by a comma.</span></label>
          <textarea id="taskTypes" ng-model="model.tasktypes" class="form-control" rows="5" placeholder="Item 1A, Category 1, Item 1B, Category 1, Item 2A, Category 2, Item 2B, Category 2, Item 3, Category 3">
          </textarea>
              <button class="btn btn-primary" type="submit" id="btntasktypes">Save</button>
            </div>
          </form>
          <br><br>
          <div class="modal-footer">
            <button class="btn btn-default" type="button" data-dismiss="modal">Close</button>
          </div>
        </mpk-modal>
      </div>


      <div ng-controller="ExportController">
        <mpk-modal visible="showExportModal" title="Export Task">
          <form name="exportKanban" class="noMargin">
            <div class="form-group">
              <label class="control-label" for="kanbanToExport">To export:</label>
              <div>
                <select id="kanbanToExport" ng-model="model.selectedKanban" class="form-control"
                        ng-options="name for name in model.allKanbanNames" ng-disabled="model.exportAll">
                </select>
              </div>
            </div>
            <div class="form-group">
              <div>
                <div class="checkbox">
                  <label>
                    <input type="checkbox" ng-model="model.exportAll"> Export all Tasks
                  </label>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-default" type="button" data-dismiss="modal">Close</button>
              <button class="btn btn-primary" type="submit" ng-click="doExport()">Export</button>
            </div>
          </form>
        </mpk-modal>
      </div>


      <div ng-controller="ImportController">
        <mpk-modal visible="showImportModal" title="Import Task from file">
          <form name="importKanban" class="noMargin">
            <div class="form-group">
              <label class="control-label" for="kanbanToExport">Select file:</label>
              <input type="file" id="kanbanFile" name="kanbanFile" read-file ng-model="model.file" ng-change="model.fileSelected=true"/>
            </div>
            <div class="alert alert-warning">If you import Task with the name that already exists, all the content of existing Task will be lost.</div>
            <div class="modal-footer">
              <button class="btn btn-default" type="button" data-dismiss="modal">Close</button>
              <button class="btn btn-primary" type="submit" ng-click="import()" ng-disabled="model.file==''">Import</button>
            </div>
          </form>
          </mpk-mdodal>
      </div>

    </script>

    <footer>
      <button id="totop" class="btn btn-default pull-right"><span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>&nbsp;&nbsp;Top&nbsp;&nbsp;</button>
    </footer>


    <%= javascript_include_tag "planner/application" %>

    <script type="text/ng-template" id="custom-datepicker.html">
      <div class="enhanced-datepicker">
        <div class="proxied-field-wrap">
          <label>
            <input type="text" ui-date-format="mm-dd-yy" ng-model="ngModel" ui-date="dateOptions"/>
            <button type="button" class="btn btn-sm btn-default" ng-click="openDatePicker()"><i class="glyphicon glyphicon-calendar"></i></button>
          </label>
        </div>
    </script>

    <script>
      function limitChange() {
        "use strict";
        var newlimit = $("#columnLimit").val();
        if (newlimit !== "") {
          newlimit = Number(newlimit);
          var cardstotal = Number($("#cardsTotal").val());
          if (newlimit < cardstotal) {
            $("#columnLimit").val(cardstotal);
            alert('Warning: Card limit may not be less than total existing cards!');
          }
        }
      }

      $("#totop").click(function () {
        "use strict";
        window.scrollTo(0, 0);
      });
    </script>
  </div>
</div>