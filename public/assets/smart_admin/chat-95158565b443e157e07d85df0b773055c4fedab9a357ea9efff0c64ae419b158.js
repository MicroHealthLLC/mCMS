function trace(e){if("\n"===e[e.length-1]&&(e=e.substring(0,e.length-1)),window.performance){var t=(window.performance.now()/1e3).toFixed(3);console.log(t+": "+e)}else console.log(e)}function requestUserMedia(e){return new Promise(function(t,n){var i=function(e){t(e)},o=function(e){n(e)};try{getUserMedia(e,i,o)}catch(e){n(e)}})}function mergeConstraints(e,t){if(!e||!t)return e||t;var n=e;for(var i in t.mandatory)n.mandatory[i]=t.mandatory[i];return n.optional=n.optional.concat(t.optional),n}function iceCandidateType(e){return e.split(" ")[7]}function maybeSetOpusOptions(e,t){return"true"===t.opusStereo?e=setCodecParam(e,"opus/48000","stereo","1"):"false"===t.opusStereo&&(e=removeCodecParam(e,"opus/48000","stereo")),"true"===t.opusFec?e=setCodecParam(e,"opus/48000","useinbandfec","1"):"false"===t.opusFec&&(e=removeCodecParam(e,"opus/48000","useinbandfec")),t.opusMaxPbr&&(e=setCodecParam(e,"opus/48000","maxplaybackrate",t.opusMaxPbr)),e}function maybeSetAudioSendBitRate(e,t){return t.audioSendBitrate?(trace("Prefer audio send bitrate: "+t.audioSendBitrate),preferBitRate(e,t.audioSendBitrate,"audio")):e}function maybeSetAudioReceiveBitRate(e,t){return t.audioRecvBitrate?(trace("Prefer audio receive bitrate: "+t.audioRecvBitrate),preferBitRate(e,t.audioRecvBitrate,"audio")):e}function maybeSetVideoSendBitRate(e,t){return t.videoSendBitrate?(trace("Prefer video send bitrate: "+t.videoSendBitrate),preferBitRate(e,t.videoSendBitrate,"video")):e}function maybeSetVideoReceiveBitRate(e,t){return t.videoRecvBitrate?(trace("Prefer video receive bitrate: "+t.videoRecvBitrate),preferBitRate(e,t.videoRecvBitrate,"video")):e}function preferBitRate(e,t,n){var i=e.split("\r\n"),o=findLine(i,"m=",n);if(null===o)return trace("Failed to add bandwidth line to sdp, as no m-line found"),e;var r=findLineInRange(i,o+1,-1,"m=");null===r&&(r=i.length);var s=findLineInRange(i,o+1,r,"c=");if(null===s)return trace("Failed to add bandwidth line to sdp, as no c-line found"),e;var a=findLineInRange(i,s+1,r,"b=AS");a&&i.splice(a,1);var l="b=AS:"+t;return i.splice(s+1,0,l),e=i.join("\r\n")}function maybeSetVideoSendInitialBitRate(e,t){var n=t.videoSendInitialBitrate;if(!n)return e;var i=n,o=t.videoSendBitrate;o&&(n>o&&(trace("Clamping initial bitrate to max bitrate of "+o+" kbps."),n=o,t.videoSendInitialBitrate=n),i=o);var r=e.split("\r\n"),s=findLine(r,"m=","video");return null===s?(trace("Failed to find video m-line"),e):(e=setCodecParam(e,"VP8/90000","x-google-min-bitrate",t.videoSendInitialBitrate.toString()),e=setCodecParam(e,"VP8/90000","x-google-max-bitrate",i.toString()))}function maybePreferAudioSendCodec(e,t){return maybePreferCodec(e,"audio","send",t.audioSendCodec)}function maybePreferAudioReceiveCodec(e,t){return maybePreferCodec(e,"audio","receive",t.audioRecvCodec)}function maybePreferVideoSendCodec(e,t){return maybePreferCodec(e,"video","send",t.videoSendCodec)}function maybePreferVideoReceiveCodec(e,t){return maybePreferCodec(e,"video","receive",t.videoRecvCodec)}function maybePreferCodec(e,t,n,i){var o=t+" "+n+" codec";if(""===i)return trace("No preference on "+o+"."),e;trace("Prefer "+o+": "+i);var r=e.split("\r\n"),s=findLine(r,"m=",t);if(null===s)return e;var a=getCodecPayloadType(r,i);return a&&(r[s]=setDefaultCodec(r[s],a)),e=r.join("\r\n")}function setCodecParam(e,t,n,i){var o=e.split("\r\n"),r=findFmtpLine(o,t),s={};if(null===r){var a=findLine(o,"a=rtpmap",t);if(null===a)return e;var l=getCodecPayloadTypeFromLine(o[a]);s.pt=l.toString(),s.params={},s.params[n]=i,o.splice(a+1,0,writeFmtpLine(s))}else s=parseFmtpLine(o[r]),s.params[n]=i,o[r]=writeFmtpLine(s);return e=o.join("\r\n")}function removeCodecParam(e,t,n){var i=e.split("\r\n"),o=findFmtpLine(i,t);if(null===o)return e;var r=parseFmtpLine(i[o]);delete r.params[n];var s=writeFmtpLine(r);return null===s?i.splice(o,1):i[o]=s,e=i.join("\r\n")}function parseFmtpLine(e){var t={},n=e.indexOf(" "),i=e.substring(n+1).split("; "),o=new RegExp("a=fmtp:(\\d+)"),r=e.match(o);if(!r||2!==r.length)return null;t.pt=r[1];for(var s={},a=0;a<i.length;++a){var l=i[a].split("=");2===l.length&&(s[l[0]]=l[1])}return t.params=s,t}function writeFmtpLine(e){if(!e.hasOwnProperty("pt")||!e.hasOwnProperty("params"))return null;var t=e.pt,n=e.params,i=[],o=0;for(var r in n)i[o]=r+"="+n[r],++o;return 0===o?null:"a=fmtp:"+t.toString()+" "+i.join("; ")}function findFmtpLine(e,t){var n=getCodecPayloadType(e,t);return n?findLine(e,"a=fmtp:"+n.toString()):null}function findLine(e,t,n){return findLineInRange(e,0,-1,t,n)}function findLineInRange(e,t,n,i,o){for(var r=n!==-1?n:e.length,s=t;s<r;++s)if(0===e[s].indexOf(i)&&(!o||e[s].toLowerCase().indexOf(o.toLowerCase())!==-1))return s;return null}function getCodecPayloadType(e,t){var n=findLine(e,"a=rtpmap",t);return n?getCodecPayloadTypeFromLine(e[n]):null}function getCodecPayloadTypeFromLine(e){var t=new RegExp("a=rtpmap:(\\d+) \\w+\\/\\d+"),n=e.match(t);return n&&2===n.length?n[1]:null}function setDefaultCodec(e,t){var n=e.split(" "),i=n.slice(0,3);i.push(t);for(var o=3;o<n.length;o++)n[o]!==t&&i.push(n[o]);return i.join(" ")}function extractStatAsInt(e,t,n){var i=extractStat(e,t,n);if(i){var o=parseInt(i);if(o!==-1)return o}return null}function extractStat(e,t,n){var i=getStatsReport(e,t,n);return i&&i.names().indexOf(n)!==-1?i.stat(n):null}function getStatsReport(e,t,n,i){if(e)for(var o=0;o<e.length;++o){var r=e[o];if(r.type===t){var s=!0;if(n){var a=r.stat(n);s=void 0!==i?a===i:a}if(s)return r}}}function computeRate(e,t,n){var i=e.stat(n),o=t?t.stat(n):null;return null===i||null===o?null:(i-o)/(e.timestamp-t.timestamp)*1e3}function computeBitrate(e,t,n){return 8*computeRate(e,t,n)}function computeE2EDelay(e,t){if(!e)return null;var n=Date.now()+22089888e5;return n-e-1e3*t}function $(e){return document.querySelector(e)}function queryStringToDictionary(e){var t=e.slice(1).split("&"),n={};return t.forEach(function(e){e&&(e=e.split("="),e[0]&&(n[e[0]]=decodeURIComponent(e[1]||"")))}),n}function sendAsyncUrlRequest(e,t,n){return new Promise(function(i,o){var r=new XMLHttpRequest;r.onreadystatechange=function(){if(4===r.readyState)return 200!==r.status?void o(Error("Status="+r.status+", response="+r.responseText)):void i(r.responseText)},r.open(e,t,!0),r.send(n)})}function requestTurnServers(e,t){return new Promise(function(n,i){sendAsyncUrlRequest("GET",e).then(function(e){var o=parseJSON(e);if(!o)return void i(Error("Error parsing response JSON: "+e));t.length>0&&filterTurnUrls(o.uris,t);var r=createIceServers(o.uris,o.username,o.password);return r?(trace("Retrieved TURN server information."),void n(r)):void i(Error("Error creating ICE servers from response."))})["catch"](function(e){i(Error("TURN server request error: "+e.message))})})}function parseJSON(e){try{return JSON.parse(e)}catch(t){trace("Error parsing json: "+e)}return null}function filterTurnUrls(e,t){for(var n=0;n<e.length;){var i=e[n].split("?");i.length>1&&i[1]!=="transport="+t?e.splice(n,1):++n}}function setUpFullScreen(){isChromeApp()?document.cancelFullScreen=function(){chrome.app.window.current().restore()}:document.cancelFullScreen=document.webkitCancelFullScreen||document.mozCancelFullScreen||document.cancelFullScreen,isChromeApp()?document.body.requestFullScreen=function(){chrome.app.window.current().fullscreen()}:document.body.requestFullScreen=document.body.webkitRequestFullScreen||document.body.mozRequestFullScreen||document.body.requestFullScreen,document.onfullscreenchange=document.onfullscreenchange||document.onwebkitfullscreenchange||document.onmozfullscreenchange}function isFullScreen(){return isChromeApp()?chrome.app.window.current().isFullscreen():!!(document.webkitIsFullScreen||document.mozFullScreen||document.isFullScreen)}function fullScreenElement(){return document.webkitFullScreenElement||document.webkitCurrentFullScreenElement||document.mozFullScreenElement||document.fullScreenElement}function randomString(e){var t=[];e=e||5;for(var n="0123456789";e--;)t.push(n.charAt(Math.floor(Math.random()*n.length)));return t.join("")}function isChromeApp(){return"undefined"!=typeof chrome&&"undefined"!=typeof chrome.storage&&"undefined"!=typeof chrome.storage.local}var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null;if(navigator.mozGetUserMedia)console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),RTCPeerConnection=function(e,t){if(e&&e.iceServers)for(var n=0;n<e.iceServers.length;n++)e.iceServers[n].hasOwnProperty("urls")&&(e.iceServers[n].url=e.iceServers[n].urls,delete e.iceServers[n].urls);return new mozRTCPeerConnection(e,t)},window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,MediaStreamTrack.getSources=function(e){setTimeout(function(){var t=[{kind:"audio",id:"default",label:"",facing:""},{kind:"video",id:"default",label:"",facing:""}];e(t)},0)},window.createIceServer=function(e,t,n){var i=null,o=e.split(":");if(0===o[0].indexOf("stun"))i={url:e};else if(0===o[0].indexOf("turn"))if(webrtcDetectedVersion<27){var r=e.split("?");1!==r.length&&0!==r[1].indexOf("transport=udp")||(i={url:r[0],credential:n,username:t})}else i={url:e,credential:n,username:t};return i},window.createIceServers=function(e,t,n){for(var i=[],o=0;o<e.length;o++){var r=window.createIceServer(e[o],t,n);null!==r&&i.push(r)}return i},attachMediaStream=function(e,t){console.log("Attaching media stream"),e.mozSrcObject=t},reattachMediaStream=function(e,t){console.log("Reattaching media stream"),e.mozSrcObject=t.mozSrcObject};else if(navigator.webkitGetUserMedia){console.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome";var result=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);webrtcDetectedVersion=null!==result?parseInt(result[2],10):999,window.createIceServer=function(e,t,n){var i=null,o=e.split(":");return 0===o[0].indexOf("stun")?i={url:e}:0===o[0].indexOf("turn")&&(i={url:e,credential:n,username:t}),i},window.createIceServers=function(e,t,n){return{urls:e,credential:n,username:t}},RTCPeerConnection=function(e,t){return new webkitRTCPeerConnection(e,t)},getUserMedia=navigator.webkitGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,attachMediaStream=function(e,t){"undefined"!=typeof e.srcObject?e.srcObject=t:"undefined"!=typeof e.mozSrcObject?e.mozSrcObject=t:"undefined"!=typeof e.src?e.src=URL.createObjectURL(t):console.log("Error attaching stream to element.")},reattachMediaStream=function(e,t){e.src=t.src}}else console.log("Browser does not appear to be WebRTC-capable");var remoteVideo=$("#remote-video"),UI_CONSTANTS={confirmJoinButton:"#confirm-join-button",confirmJoinDiv:"#confirm-join-div",confirmJoinRoomSpan:"#confirm-join-room-span",fullscreenSvg:"#fullscreen",hangupSvg:"#hangup",icons:"#icons",infoDiv:"#info-div",localVideo:"#local-video",miniVideo:"#mini-video",muteAudioSvg:"#mute-audio",muteVideoSvg:"#mute-video",newRoomButton:"#new-room-button",newRoomLink:"#new-room-link",remoteVideo:"#remote-video",rejoinButton:"#rejoin-button",rejoinDiv:"#rejoin-div",rejoinLink:"#rejoin-link",roomLinkHref:"#room-link-href",roomSelectionDiv:"#room-selection",roomSelectionInput:"#room-id-input",roomSelectionInputLabel:"#room-id-input-label",roomSelectionJoinButton:"#join-button",roomSelectionRandomButton:"#random-button",roomSelectionRecentList:"#recent-rooms-list",sharingDiv:"#sharing-div",statusDiv:"#status-div",videosDiv:"#videos"},AppController=function(e){trace("Initializing; server= "+e.roomServer+"."),trace("Initializing; room="+e.roomId+"."),this.hangupSvg_=$(UI_CONSTANTS.hangupSvg),this.icons_=$(UI_CONSTANTS.icons),this.localVideo_=$(UI_CONSTANTS.localVideo),this.miniVideo_=$(UI_CONSTANTS.miniVideo),this.sharingDiv_=$(UI_CONSTANTS.sharingDiv),this.statusDiv_=$(UI_CONSTANTS.statusDiv),this.remoteVideo_=$(UI_CONSTANTS.remoteVideo),this.videosDiv_=$(UI_CONSTANTS.videosDiv),this.roomLinkHref_=$(UI_CONSTANTS.roomLinkHref),this.rejoinDiv_=$(UI_CONSTANTS.rejoinDiv),this.rejoinLink_=$(UI_CONSTANTS.rejoinLink),this.newRoomLink_=$(UI_CONSTANTS.newRoomLink),this.rejoinButton_=$(UI_CONSTANTS.rejoinButton),this.newRoomButton_=$(UI_CONSTANTS.newRoomButton),this.newRoomButton_.addEventListener("click",this.onNewRoomClick_.bind(this),!1),this.rejoinButton_.addEventListener("click",this.onRejoinClick_.bind(this),!1),this.muteAudioIconSet_=new AppController.IconSet_(UI_CONSTANTS.muteAudioSvg),this.muteVideoIconSet_=new AppController.IconSet_(UI_CONSTANTS.muteVideoSvg),this.fullscreenIconSet_=new AppController.IconSet_(UI_CONSTANTS.fullscreenSvg),this.loadingParams_=e,this.loadUrlParams_();var t=Promise.resolve({});this.loadingParams_.paramsFunction&&(t=this.loadingParams_.paramsFunction()),Promise.resolve(t).then(function(e){if(e&&Object.keys(e).forEach(function(t){this.loadingParams_[t]=e[t]}.bind(this)),this.roomLink_="",this.roomSelection_=null,this.localStream_=null,this.remoteVideoResetTimer_=null,this.loadingParams_.roomId){this.createCall_(),RoomSelection.matchRandomRoomPattern(this.loadingParams_.roomId)||($(UI_CONSTANTS.confirmJoinRoomSpan).textContent=' "'+this.loadingParams_.roomId+'"');var t=$(UI_CONSTANTS.confirmJoinDiv);this.show_(t),$(UI_CONSTANTS.confirmJoinButton).onclick=function(){this.hide_(t);var e=new RoomSelection.RecentlyUsedList;e.pushRecentRoom(this.loadingParams_.roomId),this.finishCallSetup_(this.loadingParams_.roomId)}.bind(this),this.loadingParams_.bypassJoinConfirmation&&$(UI_CONSTANTS.confirmJoinButton).onclick()}else this.showRoomSelection_()}.bind(this))["catch"](function(e){trace("Error initializing: "+e.message)}.bind(this))};AppController.prototype.createCall_=function(){this.call_=new Call(this.loadingParams_),this.infoBox_=new InfoBox($(UI_CONSTANTS.infoDiv),this.remoteVideo_,this.call_,this.loadingParams_.versionInfo);var e=this.loadingParams_.errorMessages;if(e&&e.length>0)for(var t=0;t<e.length;++t)this.infoBox_.pushErrorMessage(e[t]);else this.call_.onremotehangup=this.onRemoteHangup_.bind(this),this.call_.onremotesdpset=this.onRemoteSdpSet_.bind(this),this.call_.onremotestreamadded=this.onRemoteStreamAdded_.bind(this),this.call_.onlocalstreamadded=this.onLocalStreamAdded_.bind(this),this.call_.onsignalingstatechange=this.infoBox_.updateInfoDiv.bind(this.infoBox_),this.call_.oniceconnectionstatechange=this.infoBox_.updateInfoDiv.bind(this.infoBox_),this.call_.onnewicecandidate=this.infoBox_.recordIceCandidateTypes.bind(this.infoBox_),this.call_.onerror=this.displayError_.bind(this),this.call_.onstatusmessage=this.displayStatus_.bind(this),this.call_.oncallerstarted=this.displaySharingInfo_.bind(this)},AppController.prototype.showRoomSelection_=function(){var e=$(UI_CONSTANTS.roomSelectionDiv);this.roomSelection_=new RoomSelection(e,UI_CONSTANTS),this.show_(e),this.roomSelection_.onRoomSelected=function(t){this.hide_(e),this.createCall_(),this.finishCallSetup_(t),this.roomSelection_=null,this.localStream_&&this.attachLocalStream_()}.bind(this)},AppController.prototype.finishCallSetup_=function(e){this.call_.start(e),window.onbeforeunload=this.call_.hangup.bind(this.call_),document.onkeypress=this.onKeyPress_.bind(this),window.onmousemove=this.showIcons_.bind(this),$(UI_CONSTANTS.muteAudioSvg).onclick=this.toggleAudioMute_.bind(this),$(UI_CONSTANTS.muteVideoSvg).onclick=this.toggleVideoMute_.bind(this),$(UI_CONSTANTS.fullscreenSvg).onclick=this.toggleFullScreen_.bind(this),$(UI_CONSTANTS.hangupSvg).onclick=this.hangup_.bind(this),setUpFullScreen(),isChromeApp()||(window.onpopstate=function(e){e.state?e.state.roomLink&&(location.href=e.state.roomLink):(trace("Reloading main page."),location.href=location.origin)})},AppController.prototype.hangup_=function(){trace("Hanging up."),this.hide_(this.icons_),this.displayStatus_("Hanging up"),this.transitionToDone_(),this.call_.hangup()},AppController.prototype.onRemoteHangup_=function(){this.displayStatus_("The remote side hung up."),this.transitionToWaiting_(),this.call_.onRemoteHangup()},AppController.prototype.onRemoteSdpSet_=function(e){e?(trace("Waiting for remote video."),this.waitForRemoteVideo_()):(trace("No remote video stream; not waiting for media to arrive."),this.transitionToActive_())},AppController.prototype.waitForRemoteVideo_=function(){this.remoteVideo_.readyState>=2?(trace("Remote video started; currentTime: "+this.remoteVideo_.currentTime),this.transitionToActive_()):this.remoteVideo_.oncanplay=this.waitForRemoteVideo_.bind(this)},AppController.prototype.onRemoteStreamAdded_=function(e){this.deactivate_(this.sharingDiv_),trace("Remote stream added."),attachMediaStream(this.remoteVideo_,e),this.remoteVideoResetTimer_&&(clearTimeout(this.remoteVideoResetTimer_),this.remoteVideoResetTimer_=null)},AppController.prototype.onLocalStreamAdded_=function(e){trace("User has granted access to local media."),this.localStream_=e,this.roomSelection_||this.attachLocalStream_()},AppController.prototype.attachLocalStream_=function(){attachMediaStream(this.localVideo_,this.localStream_),this.displayStatus_(""),this.activate_(this.localVideo_),this.show_(this.icons_)},AppController.prototype.transitionToActive_=function(){this.remoteVideo_.oncanplay=void 0;var e=window.performance.now();this.infoBox_.setSetupTimes(this.call_.startTime,e),this.infoBox_.updateInfoDiv(),trace("Call setup time: "+(e-this.call_.startTime).toFixed(0)+"ms."),trace("reattachMediaStream: "+this.localVideo_.src),reattachMediaStream(this.miniVideo_,this.localVideo_),this.activate_(this.remoteVideo_),this.activate_(this.miniVideo_),this.deactivate_(this.localVideo_),this.localVideo_.src="",this.activate_(this.videosDiv_),this.show_(this.hangupSvg_),this.displayStatus_("")},AppController.prototype.transitionToWaiting_=function(){this.remoteVideo_.oncanplay=void 0,this.hide_(this.hangupSvg_),this.deactivate_(this.videosDiv_),this.remoteVideoResetTimer_||(this.remoteVideoResetTimer_=setTimeout(function(){this.remoteVideoResetTimer_=null,trace("Resetting remoteVideo src after transitioning to waiting."),this.remoteVideo_.src=""}.bind(this),800)),this.localVideo_.src=this.miniVideo_.src,this.activate_(this.localVideo_),this.deactivate_(this.remoteVideo_),this.deactivate_(this.miniVideo_)},AppController.prototype.transitionToDone_=function(){this.remoteVideo_.oncanplay=void 0,this.deactivate_(this.localVideo_),this.deactivate_(this.remoteVideo_),this.deactivate_(this.miniVideo_),this.hide_(this.hangupSvg_),this.activate_(this.rejoinDiv_),this.show_(this.rejoinDiv_),this.displayStatus_("")},AppController.prototype.onRejoinClick_=function(){this.deactivate_(this.rejoinDiv_),this.hide_(this.rejoinDiv_),this.call_.restart()},AppController.prototype.onNewRoomClick_=function(){this.deactivate_(this.rejoinDiv_),this.hide_(this.rejoinDiv_),this.showRoomSelection_()},AppController.prototype.onKeyPress_=function(e){switch(String.fromCharCode(e.charCode)){case" ":case"m":return this.call_&&this.call_.toggleAudioMute(),!1;case"c":return this.call_&&this.call_.toggleVideoMute(),!1;case"f":return this.toggleFullScreen_(),!1;case"i":return this.infoBox_.toggleInfoDiv(),!1;case"q":return this.hangup_(),!1;default:return}},AppController.prototype.pushCallNavigation_=function(e,t){isChromeApp()||window.history.pushState({roomId:e,roomLink:t},e,t)},AppController.prototype.displaySharingInfo_=function(e,t){this.roomLinkHref_.href=t,this.roomLinkHref_.text=t,this.roomLink_=t,this.pushCallNavigation_(e,t),this.activate_(this.sharingDiv_)},AppController.prototype.displayStatus_=function(e){""===e?this.deactivate_(this.statusDiv_):this.activate_(this.statusDiv_),this.statusDiv_.innerHTML=e},AppController.prototype.displayError_=function(e){trace(e),this.infoBox_.pushErrorMessage(e)},AppController.prototype.toggleAudioMute_=function(){this.call_.toggleAudioMute(),this.muteAudioIconSet_.toggle()},AppController.prototype.toggleVideoMute_=function(){this.call_.toggleVideoMute(),this.muteVideoIconSet_.toggle()},AppController.prototype.toggleFullScreen_=function(){isFullScreen()?(trace("Exiting fullscreen."),document.cancelFullScreen()):(trace("Entering fullscreen."),document.body.requestFullScreen()),this.fullscreenIconSet_.toggle()},AppController.prototype.hide_=function(e){e.classList.add("hidden")},AppController.prototype.show_=function(e){e.classList.remove("hidden")},AppController.prototype.activate_=function(e){e.classList.add("active")},AppController.prototype.deactivate_=function(e){e.classList.remove("active")},AppController.prototype.showIcons_=function(){this.icons_.classList.contains("active")||(this.activate_(this.icons_),setTimeout(function(){this.deactivate_(this.icons_)}.bind(this),5e3))},AppController.prototype.loadUrlParams_=function(){var e=queryStringToDictionary(window.location.search);this.loadingParams_.audioSendBitrate=e.asbr,this.loadingParams_.audioSendCodec=e.asc,this.loadingParams_.audioRecvBitrate=e.arbr,this.loadingParams_.audioRecvCodec=e.arc,this.loadingParams_.opusMaxPbr=e.opusmaxpbr,this.loadingParams_.opusFec=e.opusfec,this.loadingParams_.opusStereo=e.stereo,this.loadingParams_.videoSendBitrate=e.vsbr,this.loadingParams_.videoSendInitialBitrate=e.vsibr,this.loadingParams_.videoSendCodec=e.vsc,this.loadingParams_.videoRecvBitrate=e.vrbr,this.loadingParams_.videoRecvCodec=e.vrc},AppController.IconSet_=function(e){this.iconElement=document.querySelector(e)},AppController.IconSet_.prototype.toggle=function(){this.iconElement.classList.contains("on")?this.iconElement.classList.remove("on"):this.iconElement.classList.add("on")};var Call=function(e){this.params_=e,this.roomServer_=e.roomServer||"",this.channel_=new SignalingChannel(e.wssUrl,e.wssPostUrl),this.channel_.onmessage=this.onRecvSignalingChannelMessage_.bind(this),this.pcClient_=null,this.localStream_=null,this.startTime=null,this.oncallerstarted=null,this.onerror=null,this.oniceconnectionstatechange=null,this.onlocalstreamadded=null,this.onnewicecandidate=null,this.onremotehangup=null,this.onremotesdpset=null,this.onremotestreamadded=null,this.onsignalingstatechange=null,this.onstatusmessage=null,this.getMediaPromise_=null,this.getTurnServersPromise_=null,this.requestMediaAndTurnServers_()};Call.prototype.requestMediaAndTurnServers_=function(){this.getMediaPromise_=this.maybeGetMedia_(),this.getTurnServersPromise_=this.maybeGetTurnServers_()},Call.prototype.isInitiator=function(){return this.params_.isInitiator},Call.prototype.start=function(e){this.connectToRoom_(e),this.params_.isLoopback&&setupLoopback(this.params_.wssUrl,e)},Call.prototype.restart=function(){this.requestMediaAndTurnServers_(),this.start(this.params_.previousRoomId)},Call.prototype.hangup=function(){if(this.startTime=null,this.localStream_&&(this.localStream_.stop(),this.localStream_=null),this.params_.roomId){this.pcClient_&&(this.pcClient_.close(),this.pcClient_=null);var e=this.roomServer_+"/leave/"+this.params_.roomId+"/"+this.params_.clientId,t=new XMLHttpRequest;t.open("POST",e,!1),t.send(),this.channel_.send(JSON.stringify({type:"bye"})),this.channel_.close(),this.params_.previousRoomId=this.params_.roomId,this.params_.roomId=null,this.params_.clientId=null}},Call.prototype.onRemoteHangup=function(){this.startTime=null,this.params_.isInitiator=!0,this.pcClient_&&(this.pcClient_.close(),this.pcClient_=null),this.startSignaling_()},Call.prototype.getPeerConnectionStates=function(){return this.pcClient_?this.pcClient_.getPeerConnectionStates():null},Call.prototype.getPeerConnectionStats=function(e){this.pcClient_&&this.pcClient_.getPeerConnectionStats(e)},Call.prototype.toggleVideoMute=function(){var e=this.localStream_.getVideoTracks();if(0===e.length)return void trace("No local video available.");trace("Toggling video mute state.");for(var t=0;t<e.length;++t)e[t].enabled=!e[t].enabled;trace("Video "+(e[0].enabled?"unmuted.":"muted."))},Call.prototype.toggleAudioMute=function(){var e=this.localStream_.getAudioTracks();if(0===e.length)return void trace("No local audio available.");trace("Toggling audio mute state.");for(var t=0;t<e.length;++t)e[t].enabled=!e[t].enabled;trace("Audio "+(e[0].enabled?"unmuted.":"muted."))},Call.prototype.connectToRoom_=function(e){this.params_.roomId=e;var t=this.channel_.open()["catch"](function(e){return this.onError_("WebSocket open error: "+e.message),Promise.reject(e)}.bind(this)),n=this.joinRoom_().then(function(e){this.params_.clientId=e.client_id,this.params_.roomId=e.room_id,this.params_.roomLink=e.room_link,this.params_.isInitiator="true"===e.is_initiator,this.params_.messages=e.messages}.bind(this))["catch"](function(e){return this.onError_("Room server join error: "+e.message),Promise.reject(e)}.bind(this));Promise.all([t,n]).then(function(){this.channel_.register(this.params_.roomId,this.params_.clientId),Promise.all([this.getTurnServersPromise_,this.getMediaPromise_]).then(function(){this.startSignaling_()}.bind(this))["catch"](function(e){this.onError_("Failed to start signaling: "+e.message)}.bind(this))}.bind(this))["catch"](function(e){this.onError_("WebSocket register error: "+e.message)}.bind(this))},Call.prototype.maybeGetMedia_=function(){var e=this.params_.mediaConstraints.audio!==!1||this.params_.mediaConstraints.video!==!1,t=null;if(e){var n=this.params_.mediaConstraints;t=requestUserMedia(n).then(function(e){trace("Got access to local media with mediaConstraints:\n  '"+JSON.stringify(n)+"'"),this.onUserMediaSuccess_(e)}.bind(this))["catch"](function(e){this.onError_("Error getting user media: "+e.message),this.onUserMediaError_(e)}.bind(this))}else t=Promise.resolve();return t},Call.prototype.maybeGetTurnServers_=function(){var e=this.params_.turnRequestUrl&&this.params_.turnRequestUrl.length>0,t=null;if(e){var n=this.params_.turnRequestUrl;t=requestTurnServers(n,this.params_.turnTransports).then(function(e){var t=this.params_.peerConnectionConfig.iceServers;this.params_.peerConnectionConfig.iceServers=t.concat(e)}.bind(this))["catch"](function(e){if(this.onstatusmessage){var t=encodeURIComponent("AppRTC demo TURN server not working");this.onstatusmessage('No TURN server; unlikely that media will traverse networks. If this persists please <a href="mailto:discuss-webrtc@googlegroups.com?subject='+t+'">report it to discuss-webrtc@googlegroups.com</a>.')}trace(e.message)}.bind(this))}else t=Promise.resolve();return t},Call.prototype.onUserMediaSuccess_=function(e){this.localStream_=e,this.onlocalstreamadded&&this.onlocalstreamadded(e)},Call.prototype.onUserMediaError_=function(e){var t="Failed to get access to local media. Error name was "+e.name+". Continuing without sending a stream.";this.onError_("getUserMedia error: "+t),alert(t)},Call.prototype.maybeCreatePcClient_=function(){if(!this.pcClient_)try{this.pcClient_=new PeerConnectionClient(this.params_,this.startTime),this.pcClient_.onsignalingmessage=this.sendSignalingMessage_.bind(this),this.pcClient_.onremotehangup=this.onremotehangup,this.pcClient_.onremotesdpset=this.onremotesdpset,this.pcClient_.onremotestreamadded=this.onremotestreamadded,this.pcClient_.onsignalingstatechange=this.onsignalingstatechange,this.pcClient_.oniceconnectionstatechange=this.oniceconnectionstatechange,this.pcClient_.onnewicecandidate=this.onnewicecandidate,this.pcClient_.onerror=this.onerror,trace("Created PeerConnectionClient")}catch(e){return this.onError_("Create PeerConnection exception: "+e.message),void alert("Cannot create RTCPeerConnection; WebRTC is not supported by this browser.")}},Call.prototype.startSignaling_=function(){trace("Starting signaling."),this.isInitiator()&&this.oncallerstarted&&this.oncallerstarted(this.params_.roomId,this.params_.roomLink),this.startTime=window.performance.now(),this.maybeCreatePcClient_(),this.localStream_&&(trace("Adding local stream."),this.pcClient_.addStream(this.localStream_)),this.params_.isInitiator?this.pcClient_.startAsCaller(this.params_.offerConstraints):this.pcClient_.startAsCallee(this.params_.messages)},Call.prototype.joinRoom_=function(){return new Promise(function(e,t){this.params_.roomId||t(Error("Missing room id."));var n=this.roomServer_+"/join/"+this.params_.roomId+window.location.search;sendAsyncUrlRequest("POST",n).then(function(n){var i=parseJSON(n);return i?"SUCCESS"!==i.result?void t(Error("Registration error: "+i.result)):(trace("Joined the room."),void e(i.params)):void t(Error("Error parsing response JSON."))}.bind(this))["catch"](function(e){t(Error("Failed to join the room: "+e.message))}.bind(this))}.bind(this))},Call.prototype.onRecvSignalingChannelMessage_=function(e){this.maybeCreatePcClient_(),this.pcClient_.receiveSignalingMessage(e)},Call.prototype.sendSignalingMessage_=function(e){var t=JSON.stringify(e);if(this.params_.isInitiator){var n=this.roomServer_+"/message/"+this.params_.roomId+"/"+this.params_.clientId+window.location.search,i=new XMLHttpRequest;i.open("POST",n,!0),i.send(t),trace("C->GAE: "+t)}else this.channel_.send(t)},Call.prototype.onError_=function(e){this.onerror&&this.onerror(e)};var InfoBox=function(e,t,n,i){this.infoDiv_=e,this.remoteVideo_=t,this.call_=n,this.versionInfo_=i,this.errorMessages_=[],this.startTime_=null,this.connectTime_=null,this.stats_=null,this.prevStats_=null,this.getStatsTimer_=null,this.iceCandidateTypes_={Local:{},Remote:{}}};InfoBox.prototype.recordIceCandidateTypes=function(e,t){var n=iceCandidateType(t),i=this.iceCandidateTypes_[e];i[n]?++i[n]:i[n]=1,this.updateInfoDiv()},InfoBox.prototype.pushErrorMessage=function(e){this.errorMessages_.push(e),this.updateInfoDiv(),this.showInfoDiv()},InfoBox.prototype.setSetupTimes=function(e,t){this.startTime_=e,this.connectTime_=t},InfoBox.prototype.showInfoDiv=function(){this.getStatsTimer_=setInterval(this.refreshStats_.bind(this),1e3),this.refreshStats_(),this.infoDiv_.classList.add("active")},InfoBox.prototype.toggleInfoDiv=function(){this.infoDiv_.classList.contains("active")?(clearInterval(this.getStatsTimer_),this.infoDiv_.classList.remove("active")):this.showInfoDiv()},InfoBox.prototype.refreshStats_=function(){this.call_.getPeerConnectionStats(function(e){this.prevStats_=this.stats_,this.stats_=e.result(),this.updateInfoDiv()}.bind(this))},InfoBox.prototype.updateInfoDiv=function(){var e='<pre id="info-box-stats" style="line-height: initial">';if(this.stats_){var t=this.call_.getPeerConnectionStates();if(!t)return;e+=this.buildLine_("States"),e+=this.buildLine_("Signaling",t.signalingState),e+=this.buildLine_("Gathering",t.iceGatheringState),e+=this.buildLine_("Connection",t.iceConnectionState);for(var n in this.iceCandidateTypes_){var i=[];for(var o in this.iceCandidateTypes_[n])i.push(o+":"+this.iceCandidateTypes_[n][o]);e+=this.buildLine_(n,i.join(" "))}var r,s,a,l,c=getStatsReport(this.stats_,"googCandidatePair","googActiveConnection","true");c&&(r=c.stat("googLocalAddress"),s=c.stat("googRemoteAddress"),a=c.stat("googLocalCandidateType"),l=c.stat("googRemoteCandidateType")),r&&s&&(e+=this.buildLine_("LocalAddr",r+" ("+a+")"),e+=this.buildLine_("RemoteAddr",s+" ("+l+")")),e+=this.buildLine_(),e+=this.buildStatsSection_()}if(this.errorMessages_.length){this.infoDiv_.classList.add("warning");for(var u=0;u!==this.errorMessages_.length;++u)e+=this.errorMessages_[u]+"\n"}else this.infoDiv_.classList.remove("warning");if(this.versionInfo_){e+=this.buildLine_(),e+=this.buildLine_("Version");for(var d in this.versionInfo_)e+=this.buildLine_(d,this.versionInfo_[d])}e+="</pre>",this.infoDiv_.innerHTML!==e&&(this.infoDiv_.innerHTML=e)},InfoBox.prototype.buildStatsSection_=function(){var e=this.buildLine_("Stats"),t=extractStatAsInt(this.stats_,"ssrc","googRtt"),n=extractStatAsInt(this.stats_,"ssrc","googCaptureStartNtpTimeMs"),i=computeE2EDelay(n,this.remoteVideo_.currentTime);null!==this.endTime_&&(e+=this.buildLine_("Call time",InfoBox.formatInterval_(window.performance.now()-this.connectTime_)),e+=this.buildLine_("Setup time",InfoBox.formatMsec_(this.connectTime_-this.startTime_))),null!==t&&(e+=this.buildLine_("RTT",InfoBox.formatMsec_(t))),null!==i&&(e+=this.buildLine_("End to end",InfoBox.formatMsec_(i)));var o,r,s,a,l,c,u,d,h,f,p,m,g,v,y,b,T=getStatsReport(this.stats_,"ssrc","audioInputLevel"),C=getStatsReport(this.stats_,"ssrc","audioOutputLevel"),E=getStatsReport(this.stats_,"ssrc","googFirsReceived"),D=getStatsReport(this.stats_,"ssrc","googFirsSent"),I=getStatsReport(this.prevStats_,"ssrc","audioInputLevel"),_=getStatsReport(this.prevStats_,"ssrc","audioOutputLevel"),O=getStatsReport(this.prevStats_,"ssrc","googFirsReceived"),R=getStatsReport(this.prevStats_,"ssrc","googFirsSent");return T&&(o=T.stat("googCodecName"),r=computeBitrate(T,I,"bytesSent"),s=computeRate(T,I,"packetsSent"),e+=this.buildLine_("Audio Tx",o+", "+InfoBox.formatBitrate_(r)+", "+InfoBox.formatPacketRate_(s))),
C&&(a=C.stat("googCodecName"),l=computeBitrate(C,_,"bytesReceived"),c=computeRate(C,_,"packetsReceived"),e+=this.buildLine_("Audio Rx",a+", "+InfoBox.formatBitrate_(l)+", "+InfoBox.formatPacketRate_(c))),E&&(h=E.stat("googCodecName"),u=E.stat("googFrameHeightSent"),d=E.stat("googFrameRateSent"),f=computeBitrate(E,O,"bytesSent"),p=computeRate(E,O,"packetsSent"),e+=this.buildLine_("Video Tx",h+", "+u.toString()+"p"+d.toString()+", "+InfoBox.formatBitrate_(f)+", "+InfoBox.formatPacketRate_(p))),D&&(v="TODO",m=this.remoteVideo_.videoHeight,g=D.stat("googFrameRateDecoded"),y=computeBitrate(D,R,"bytesReceived"),b=computeRate(D,R,"packetsReceived"),e+=this.buildLine_("Video Rx",v+", "+m.toString()+"p"+g.toString()+", "+InfoBox.formatBitrate_(y)+", "+InfoBox.formatPacketRate_(b))),e},InfoBox.prototype.buildLine_=function(e,t){var n=12,i="";if(e){for(i+=e+":";i.length<n;)i+=" ";t&&(i+=t)}return i+="\n"},InfoBox.formatInterval_=function(e){var t="",n=Math.floor(e/1e3),i=Math.floor(n/60),o=Math.floor(i/60),r=function(e){return(e<10?"0":"")+e.toString()};return o>0&&(t+=r(o)+":"),t+=r(i-60*o)+":",t+=r(n-60*i)},InfoBox.formatMsec_=function(e){return e.toFixed(0).toString()+" ms"},InfoBox.formatBitrate_=function(e){if(!e)return"- bps";var t;e<1e3?t="bps":e<1e6?(t="kbps",e/=1e3):(t="Mbps",e/=1e6);var n=e.toPrecision(3)+" "+t;return n},InfoBox.formatPacketRate_=function(e){return e?e.toPrecision(3)+" pps":"- pps"};var PeerConnectionClient=function(e,t){this.params_=e,this.startTime_=t,trace("Creating RTCPeerConnnection with:\n  config: '"+JSON.stringify(e.peerConnectionConfig)+"';\n  constraints: '"+JSON.stringify(e.peerConnectionConstraints)+"'."),this.pc_=new RTCPeerConnection(e.peerConnectionConfig,e.peerConnectionConstraints),this.pc_.onicecandidate=this.onIceCandidate_.bind(this),this.pc_.onaddstream=this.onRemoteStreamAdded_.bind(this),this.pc_.onremovestream=trace.bind(null,"Remote stream removed."),this.pc_.onsignalingstatechange=this.onSignalingStateChanged_.bind(this),this.pc_.oniceconnectionstatechange=this.onIceConnectionStateChanged_.bind(this),this.hasRemoteSdp_=!1,this.messageQueue_=[],this.isInitiator_=!1,this.started_=!1,this.onerror=null,this.oniceconnectionstatechange=null,this.onnewicecandidate=null,this.onremotehangup=null,this.onremotesdpset=null,this.onremotestreamadded=null,this.onsignalingmessage=null,this.onsignalingstatechange=null};PeerConnectionClient.DEFAULT_SDP_CONSTRAINTS_={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},optional:[{VoiceActivityDetection:!1}]},PeerConnectionClient.prototype.addStream=function(e){this.pc_&&this.pc_.addStream(e)},PeerConnectionClient.prototype.startAsCaller=function(e){if(!this.pc_)return!1;if(this.started_)return!1;this.isInitiator_=!0,this.started_=!0;var t=mergeConstraints(e,PeerConnectionClient.DEFAULT_SDP_CONSTRAINTS_);return trace("Sending offer to peer, with constraints: \n'"+JSON.stringify(t)+"'."),this.pc_.createOffer(this.setLocalSdpAndNotify_.bind(this),this.onError_.bind(this,"createOffer"),t),!0},PeerConnectionClient.prototype.startAsCallee=function(e){if(!this.pc_)return!1;if(this.started_)return!1;if(this.isInitiator_=!1,this.started_=!0,e&&e.length>0){for(var t=0,n=e.length;t<n;t++)this.receiveSignalingMessage(e[t]);return!0}return this.messageQueue_.length>0&&this.drainMessageQueue_(),!0},PeerConnectionClient.prototype.receiveSignalingMessage=function(e){var t=parseJSON(e);t&&(this.isInitiator_&&"answer"===t.type||!this.isInitiator_&&"offer"===t.type?(this.hasRemoteSdp_=!0,this.messageQueue_.unshift(t)):"candidate"===t.type?this.messageQueue_.push(t):"bye"===t.type&&this.onremotehangup&&this.onremotehangup(),this.drainMessageQueue_())},PeerConnectionClient.prototype.close=function(){this.pc_&&(this.pc_.close(),this.pc_=null)},PeerConnectionClient.prototype.getPeerConnectionStates=function(){return this.pc_?{signalingState:this.pc_.signalingState,iceGatheringState:this.pc_.iceGatheringState,iceConnectionState:this.pc_.iceConnectionState}:null},PeerConnectionClient.prototype.getPeerConnectionStats=function(e){this.pc_&&this.pc_.getStats(e)},PeerConnectionClient.prototype.doAnswer_=function(){trace("Sending answer to peer."),this.pc_.createAnswer(this.setLocalSdpAndNotify_.bind(this),this.onError_.bind(this,"createAnswer"),PeerConnectionClient.DEFAULT_SDP_CONSTRAINTS_)},PeerConnectionClient.prototype.setLocalSdpAndNotify_=function(e){e.sdp=maybePreferAudioReceiveCodec(e.sdp,this.params_),e.sdp=maybePreferVideoReceiveCodec(e.sdp,this.params_),e.sdp=maybeSetAudioReceiveBitRate(e.sdp,this.params_),e.sdp=maybeSetVideoReceiveBitRate(e.sdp,this.params_),this.pc_.setLocalDescription(e,trace.bind(null,"Set session description success."),this.onError_.bind(this,"setLocalDescription")),this.onsignalingmessage&&this.onsignalingmessage(e)},PeerConnectionClient.prototype.setRemoteSdp_=function(e){e.sdp=maybeSetOpusOptions(e.sdp,this.params_),e.sdp=maybePreferAudioSendCodec(e.sdp,this.params_),e.sdp=maybePreferVideoSendCodec(e.sdp,this.params_),e.sdp=maybeSetAudioSendBitRate(e.sdp,this.params_),e.sdp=maybeSetVideoSendBitRate(e.sdp,this.params_),e.sdp=maybeSetVideoSendInitialBitRate(e.sdp,this.params_),this.pc_.setRemoteDescription(new RTCSessionDescription(e),this.onSetRemoteDescriptionSuccess_.bind(this),this.onError_.bind(this,"setRemoteDescription"))},PeerConnectionClient.prototype.onSetRemoteDescriptionSuccess_=function(){trace("Set remote session description success.");var e=this.pc_.getRemoteStreams();this.onremotesdpset&&this.onremotesdpset(e.length>0&&e[0].getVideoTracks().length>0)},PeerConnectionClient.prototype.processSignalingMessage_=function(e){if("offer"!==e.type||this.isInitiator_)if("answer"===e.type&&this.isInitiator_){if("have-local-offer"!==this.pc_.signalingState)return void trace("ERROR: remote answer received in unexpected state: "+this.pc_.signalingState);this.setRemoteSdp_(e)}else if("candidate"===e.type){var t=new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate});this.recordIceCandidate_("Remote",t),this.pc_.addIceCandidate(t,trace.bind(null,"Remote candidate added successfully."),this.onError_.bind(this,"addIceCandidate"))}else trace("WARNING: unexpected message: "+JSON.stringify(e));else{if("stable"!==this.pc_.signalingState)return void trace("ERROR: remote offer received in unexpected state: "+this.pc_.signalingState);this.setRemoteSdp_(e),this.doAnswer_()}},PeerConnectionClient.prototype.drainMessageQueue_=function(){if(this.pc_&&this.started_&&this.hasRemoteSdp_){for(var e=0,t=this.messageQueue_.length;e<t;e++)this.processSignalingMessage_(this.messageQueue_[e]);this.messageQueue_=[]}},PeerConnectionClient.prototype.onIceCandidate_=function(e){if(e.candidate){if(this.filterIceCandidate_(e.candidate)){var t={type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate};this.onsignalingmessage&&this.onsignalingmessage(t),this.recordIceCandidate_("Local",e.candidate)}}else trace("End of candidates.")},PeerConnectionClient.prototype.onSignalingStateChanged_=function(){this.pc_&&(trace("Signaling state changed to: "+this.pc_.signalingState),this.onsignalingstatechange&&this.onsignalingstatechange())},PeerConnectionClient.prototype.onIceConnectionStateChanged_=function(){this.pc_&&(trace("ICE connection state changed to: "+this.pc_.iceConnectionState),"completed"===this.pc_.iceConnectionState&&trace("ICE complete time: "+(window.performance.now()-this.startTime_).toFixed(0)+"ms."),this.oniceconnectionstatechange&&this.oniceconnectionstatechange())},PeerConnectionClient.prototype.filterIceCandidate_=function(e){var t=e.candidate;return t.indexOf("tcp")===-1&&("relay"!==this.params_.peerConnectionConfig.iceTransports||"relay"===iceCandidateType(t))},PeerConnectionClient.prototype.recordIceCandidate_=function(e,t){this.onnewicecandidate&&this.onnewicecandidate(e,t.candidate)},PeerConnectionClient.prototype.onRemoteStreamAdded_=function(e){this.onremotestreamadded&&this.onremotestreamadded(e.stream)},PeerConnectionClient.prototype.onError_=function(e,t){this.onerror&&this.onerror(e+": "+t.toString())};var RoomSelection=function(e,t,n,i){this.roomSelectionDiv_=e,this.setupCompletedCallback_=i,this.roomIdInput_=this.roomSelectionDiv_.querySelector(t.roomSelectionInput),this.roomIdInputLabel_=this.roomSelectionDiv_.querySelector(t.roomSelectionInputLabel),this.roomJoinButton_=this.roomSelectionDiv_.querySelector(t.roomSelectionJoinButton),this.roomRandomButton_=this.roomSelectionDiv_.querySelector(t.roomSelectionRandomButton),this.roomRecentList_=this.roomSelectionDiv_.querySelector(t.roomSelectionRecentList),this.roomIdInput_.value=randomString(9),this.onRoomIdInput_(),this.roomIdInput_.addEventListener("input",this.onRoomIdInput_.bind(this),!1),this.roomIdInput_.addEventListener("keyup",this.onRoomIdKeyPress_.bind(this),!1),this.roomRandomButton_.addEventListener("click",this.onRandomButton_.bind(this),!1),this.roomJoinButton_.addEventListener("click",this.onJoinButton_.bind(this),!1),this.onRoomSelected=null,this.recentlyUsedList_=new RoomSelection.RecentlyUsedList(n),this.startBuildingRecentRoomList_()};RoomSelection.matchRandomRoomPattern=function(e){return null!==e.match(/^\d{9}$/)},RoomSelection.prototype.startBuildingRecentRoomList_=function(){this.recentlyUsedList_.getRecentRooms().then(function(e){this.buildRecentRoomList_(e),this.setupCompletedCallback_&&this.setupCompletedCallback_()}.bind(this))["catch"](function(e){trace("Error building recent rooms list: "+e.message)}.bind(this))},RoomSelection.prototype.buildRecentRoomList_=function(e){for(var t=this.roomRecentList_.lastChild;t;)this.roomRecentList_.removeChild(t),t=this.roomRecentList_.lastChild;for(var n=0;n<e.length;++n){var i=document.createElement("li"),o=document.createElement("a"),r=document.createTextNode(e[n]);o.appendChild(r),o.href=location.origin+"/r/"+encodeURIComponent(e[n]),i.appendChild(o),this.roomRecentList_.appendChild(i),o.addEventListener("click",this.makeRecentlyUsedClickHandler_(e[n]).bind(this),!1)}},RoomSelection.prototype.onRoomIdInput_=function(){var e=this.roomIdInput_.value,t=e.length>=5,n=/^\w+$/;t=t&&n.exec(e),t?(this.roomJoinButton_.disabled=!1,this.roomIdInput_.classList.remove("invalid"),this.roomIdInputLabel_.classList.add("hidden")):(this.roomJoinButton_.disabled=!0,this.roomIdInput_.classList.add("invalid"),this.roomIdInputLabel_.classList.remove("hidden"))},RoomSelection.prototype.onRoomIdKeyPress_=function(e){13!==e.which||this.roomJoinButton_.disabled||this.onJoinButton_()},RoomSelection.prototype.onRandomButton_=function(){this.roomIdInput_.value=randomString(9),this.onRoomIdInput_()},RoomSelection.prototype.onJoinButton_=function(){this.loadRoom_(this.roomIdInput_.value)},RoomSelection.prototype.makeRecentlyUsedClickHandler_=function(e){return function(t){t.preventDefault(),this.loadRoom_(e)}},RoomSelection.prototype.loadRoom_=function(e){this.recentlyUsedList_.pushRecentRoom(e),this.onRoomSelected&&this.onRoomSelected(e)},RoomSelection.RecentlyUsedList=function(e){this.LISTLENGTH_=10,this.RECENTROOMSKEY_=e||"recentRooms",this.storage_=new Storage},RoomSelection.RecentlyUsedList.prototype.pushRecentRoom=function(e){return new Promise(function(t,n){return e?void this.getRecentRooms().then(function(n){n=[e].concat(n),n=n.filter(function(e,t,n){return n.indexOf(e)===t}),n=n.slice(0,this.LISTLENGTH_),this.storage_.setStorage(this.RECENTROOMSKEY_,JSON.stringify(n),function(){t()})}.bind(this))["catch"](function(e){n(e)}.bind(this)):void t()}.bind(this))},RoomSelection.RecentlyUsedList.prototype.getRecentRooms=function(){return new Promise(function(e){this.storage_.getStorage(this.RECENTROOMSKEY_,function(t){var n=parseJSON(t);n||(n=[]),e(n)})}.bind(this))};var SignalingChannel=function(e,t){this.wssUrl_=e,this.wssPostUrl_=t,this.roomId_=null,this.clientId_=null,this.websocket_=null,this.registered_=!1,this.onerror=null,this.onmessage=null};SignalingChannel.prototype.open=function(){return this.websocket_?void trace("ERROR: SignalingChannel has already opened."):(trace("Opening signaling channel."),new Promise(function(e,t){this.websocket_=new WebSocket(this.wssUrl_),this.websocket_.onopen=function(){trace("Signaling channel opened."),this.websocket_.onerror=function(){trace("Signaling channel error.")},this.websocket_.onclose=function(e){trace("Channel closed with code:"+e.code+" reason:"+e.reason),this.websocket_=null,this.registered_=!1},this.clientId_&&this.roomId_&&this.register(this.roomId_,this.clientId_),e()}.bind(this),this.websocket_.onmessage=function(e){trace("WSS->C: "+e.data);var t=parseJSON(e.data);return t?t.error?void trace("Signaling server error message: "+t.error):void this.onmessage(t.msg):void trace("Failed to parse WSS message: "+e.data)}.bind(this),this.websocket_.onerror=function(){t(Error("WebSocket error."))}}.bind(this)))},SignalingChannel.prototype.register=function(e,t){if(this.registered_)return void trace("ERROR: SignalingChannel has already registered.");if(this.roomId_=e,this.clientId_=t,this.roomId_||trace("ERROR: missing roomId."),this.clientId_||trace("ERROR: missing clientId."),!this.websocket_||this.websocket_.readyState!==WebSocket.OPEN)return void trace("WebSocket not open yet; saving the IDs to register later.");trace("Registering signaling channel.");var n={cmd:"register",roomid:this.roomId_,clientid:this.clientId_};this.websocket_.send(JSON.stringify(n)),this.registered_=!0,trace("Signaling channel registered.")},SignalingChannel.prototype.close=function(){if(this.websocket_&&(this.websocket_.close(),this.websocket_=null),this.clientId_&&this.roomId_){var e=this.wssPostUrl_+"/"+this.roomId_+"/"+this.clientId_,t=new XMLHttpRequest;t.open("DELETE",e,!1),t.send(),this.clientId_=null,this.roomId_=null,this.registered_=!1}},SignalingChannel.prototype.send=function(e){if(!this.roomId_||!this.clientId_)return void trace("ERROR: SignalingChannel has not registered.");trace("C->WSS: "+e);var t={cmd:"send",msg:e},n=JSON.stringify(t);if(this.websocket_&&this.websocket_.readyState===WebSocket.OPEN)this.websocket_.send(n);else{var i=this.wssPostUrl_+"/"+this.roomId_+"/"+this.clientId_,o=new XMLHttpRequest;o.open("POST",i,!0),o.send(t.msg)}};var Storage=function(){};Storage.prototype.getStorage=function(e,t){if(isChromeApp())chrome.storage.local.get(e,function(n){t&&window.setTimeout(function(){t(n[e])},0)});else{var n=localStorage.getItem(e);t&&window.setTimeout(function(){t(n)},0)}},Storage.prototype.setStorage=function(e,t,n){if(isChromeApp()){var i={};i[e]=t,chrome.storage.local.set(i,n)}else localStorage.setItem(e,t),n&&window.setTimeout(n,0)};